<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Tech Tasks</title>
  <base href="/">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
    body { font-family: 'Inter', sans-serif; }
    
    /* Ensuring inputs maintain the dark theme appearance across browsers */
    input, select, textarea {
      background-color: #1e293b !important;
      border: 1px solid #334155 !important;
      color: #f8fafc !important;
    }

  </style>
</head>
<body class="bg-[#0f172a] text-[#f8fafc] min-h-screen">
  <div id="app-content"></div>

  <script>
    const API_URL = 'http://localhost:3000/api';
    let currentUser = null;
    let authToken = null;

    const appContent = document.getElementById('app-content');

    function renderLogin() {
      appContent.innerHTML = `
        <div class="flex items-center justify-center min-h-screen p-4">
          <div class="bg-[#1e293b] p-8 rounded-xl border border-slate-700 w-full max-w-md shadow-2xl">
            <h2 class="text-2xl font-bold mb-8 text-center text-indigo-500">Tech Tasks Login</h2>
            
            <form id="loginForm" class="flex flex-col gap-5">
              <div>
                <label class="block text-sm font-medium mb-2 text-slate-400">Email</label>
                <input type="email" id="email" placeholder="owner@test.com" class="w-full p-3 rounded-lg text-sm transition-all" required />
              </div>
              
              <div>
                <label class="block text-sm font-medium mb-2 text-slate-400">Password</label>
                <input type="password" id="password" placeholder="••••••••" class="w-full p-3 rounded-lg text-sm transition-all" required />
              </div>

              <button type="submit" class="w-full py-3 mt-2 rounded-lg font-bold bg-indigo-600 hover:bg-indigo-500 text-white transition-all shadow-lg shadow-indigo-500/20 active:scale-95">
                Login
              </button>
            </form>

            <div class="mt-8 pt-6 border-t border-slate-700 text-sm text-slate-500">
              <p class="font-bold mb-2 text-slate-400">Test Accounts:</p>
              <ul class="space-y-1">
                <li>owner@test.com / password123</li>
                <li>admin@test.com / password123</li>
                <li>viewer@test.com / password123</li>
              </ul>
            </div>
          </div>
        </div>
      `;
      document.getElementById('loginForm').addEventListener('submit', handleLogin);
    }

    function renderDashboard() {
      appContent.innerHTML = `
        <div class="p-4 md:p-8">
          <div class="bg-[#1e293b] p-6 rounded-xl border border-slate-700 mb-8 flex justify-between items-center shadow-xl">
            <h1 class="text-xl font-bold text-white tracking-tight">Tech Tasks</h1>
            <div class="flex items-center gap-4">
              <span id="userDisplay" class="hidden md:inline text-xs text-slate-400 font-mono"></span>
              <button id="logoutBtn" class="px-4 py-2 rounded-md text-xs font-bold bg-red-600 hover:bg-red-500 text-white transition-colors uppercase tracking-wider">
                Logout
              </button>
            </div>
          </div>

          <div class="max-w-7xl mx-auto">
            <div id="createTaskDiv" class="bg-[#1e293b] rounded-xl border border-slate-700 p-6 mb-8 shadow-lg">
              <h2 class="text-lg font-bold mb-6 text-white">Create New Task</h2>
              <form id="createTaskForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" id="taskTitle" placeholder="Task title" class="p-3 rounded-lg text-sm transition-all" required />
                <select id="taskCategory" class="p-3 rounded-lg text-sm transition-all">
                  <option value="Work">Work</option>
                  <option value="Personal">Personal</option>
                  <option value="Shopping">Shopping</option>
                  <option value="Health">Health</option>
                </select>
                <textarea id="taskDesc" placeholder="Description" class="p-3 rounded-lg text-sm md:col-span-2 min-h-[80px] transition-all"></textarea>
                <button type="submit" class="md:col-span-2 py-3 rounded-lg font-bold bg-indigo-600 hover:bg-indigo-500 text-white transition-all active:scale-[0.99]">
                  Add Task
                </button>
              </form>
            </div>

            <div class="bg-[#1e293b] rounded-xl border border-slate-700 p-6 shadow-lg">
              <h2 class="text-lg font-bold mb-6 text-white border-b border-slate-700 pb-2">Tasks</h2>
              <div id="tasksList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>
          </div>
        </div>
      `;

      document.getElementById('logoutBtn').addEventListener('click', handleLogout);
      document.getElementById('createTaskForm').addEventListener('submit', handleCreateTask);
      document.getElementById('userDisplay').textContent = `${currentUser.email} [${currentUser.role}]`;
      loadTasks();
    }

    async function handleLogin(e) {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      try {
        const res = await fetch(`${API_URL}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await res.json();
        if (res.ok) {
          authToken = data.access_token;
          currentUser = data.user;
          localStorage.setItem('access_token', authToken);
          localStorage.setItem('user', JSON.stringify(currentUser));
          renderDashboard();
        } else {
          alert('Login failed: ' + (data.message || 'Invalid credentials'));
        }
      } catch (err) {
        alert('Error connecting to server.');
      }
    }

    function handleLogout() {
      localStorage.removeItem('access_token');
      localStorage.removeItem('user');
      authToken = null;
      currentUser = null;
      renderLogin();
    }

    async function handleCreateTask(e) {
      e.preventDefault();
      const title = document.getElementById('taskTitle').value;
      const description = document.getElementById('taskDesc').value;
      const category = document.getElementById('taskCategory').value;

      try {
        const res = await fetch(`${API_URL}/tasks`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({ title, description, category, status: 'TODO' })
        });

        if (res.ok) {
          document.getElementById('createTaskForm').reset();
          loadTasks();
        } else {
          alert('Failed to create task');
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function loadTasks() {
      try {
        const res = await fetch(`${API_URL}/tasks`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });

        const tasks = await res.json();
        const tasksList = document.getElementById('tasksList');
        tasksList.innerHTML = '';

        if (!Array.isArray(tasks) || tasks.length === 0) {
          tasksList.innerHTML = '<p class="text-slate-500 italic text-sm">No tasks found.</p>';
          return;
        }

        tasks.forEach(task => {
          const isViewer = currentUser.role === 'VIEWER';
          const statusColors = { 
            'TODO': 'bg-amber-500', 
            'IN_PROGRESS': 'bg-indigo-500', 
            'DONE': 'bg-emerald-500' 
          };

          const taskEl = document.createElement('div');
          taskEl.className = "bg-slate-900 border border-slate-800 rounded-lg p-5 flex flex-col justify-between shadow-inner hover:border-slate-600 transition-all";

          taskEl.innerHTML = `
            <div>
              <div class="flex justify-between items-start mb-2">
                <h3 class="font-bold text-white">${task.title}</h3>
              </div>
              <p class="text-slate-400 text-sm mb-4 h-12 overflow-y-auto">${task.description || 'No description provided.'}</p>
              <div class="flex gap-2 mb-4">
                <span class="bg-slate-800 px-2 py-1 rounded text-[10px] text-slate-400 uppercase font-bold">${task.category}</span>
                <span class="${statusColors[task.status] || 'bg-indigo-500'} text-white px-2 py-1 rounded text-[10px] uppercase font-bold">${task.status}</span>
              </div>
            </div>
            <div class="flex gap-2 pt-4 border-t border-slate-800">
              <select 
                class="flex-1 p-2 rounded text-xs transition-opacity ${isViewer ? 'opacity-50' : ''}"
                ${isViewer ? 'disabled' : ''}
                onchange="updateTaskStatus('${task.id}', this.value)"
              >
                <option value="TODO" ${task.status === 'TODO' ? 'selected' : ''}>To Do</option>
                <option value="IN_PROGRESS" ${task.status === 'IN_PROGRESS' ? 'selected' : ''}>In Progress</option>
                <option value="DONE" ${task.status === 'DONE' ? 'selected' : ''}>Done</option>
              </select>
              <button 
                onclick="deleteTask('${task.id}')"
                class="px-3 py-2 rounded bg-red-600 hover:bg-red-500 text-white text-xs font-bold transition-all ${isViewer ? 'opacity-50 cursor-not-allowed' : 'active:scale-90'}"
                ${isViewer ? 'disabled' : ''}
              >
                Delete
              </button>
            </div>
          `;
          tasksList.appendChild(taskEl);
        });
      } catch (err) {
        console.error('Task loading error:', err.message);
      }
    }

    async function updateTaskStatus(taskId, status) {
      try {
        const res = await fetch(`${API_URL}/tasks/${taskId}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({ status })
        });
        if (res.ok) loadTasks();
      } catch (err) { alert('Error: ' + err.message); }
    }

    async function deleteTask(taskId) {
      if (!confirm('Delete this task?')) return;
      try {
        const res = await fetch(`${API_URL}/tasks/${taskId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (res.ok) loadTasks();
      } catch (err) { alert('Error: ' + err.message); }
    }

    // Initialize
    const token = localStorage.getItem('access_token');
    const user = localStorage.getItem('user');
    if (token && user) {
      authToken = token;
      currentUser = JSON.parse(user);
      renderDashboard();
    } else {
      renderLogin();
    }
  </script>
</body>
</html>