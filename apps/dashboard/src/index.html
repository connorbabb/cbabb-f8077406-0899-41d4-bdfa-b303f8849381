<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Task Manager</title>
  <base href="/">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="stylesheet" href="./styles.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: #f3f4f6;
    }
  </style>
</head>
<body>
  <div id="app-content"></div>

  <script>
    const API_URL = 'http://localhost:3000/api';
    let currentUser = null;
    let authToken = null;

    const appContent = document.getElementById('app-content');

    // Render Login Screen
    function renderLogin() {
      appContent.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background-color: #f3f4f6;">
          <div style="background: white; padding: 2rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); width: 100%; max-width: 24rem;">
            <h2 style="font-size: 1.875rem; font-weight: bold; margin-bottom: 1.5rem; text-align: center; color: #111827;">Task Manager Login</h2>
            
            <form id="loginForm" style="display: flex; flex-direction: column; gap: 1rem;">
              <div>
                <label style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.25rem; color: #374151;">Email</label>
                <input 
                  type="email" 
                  id="email" 
                  placeholder="owner@test.com"
                  style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 1rem;"
                  required
                />
              </div>
              
              <div>
                <label style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.25rem; color: #374151;">Password</label>
                <input 
                  type="password" 
                  id="password"
                  placeholder="password123"
                  style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 1rem;"
                  required
                />
              </div>

              <button 
                type="submit"
                style="width: 100%; padding: 0.75rem; border-radius: 0.375rem; font-weight: 600; background-color: #2563eb; color: white; border: none; cursor: pointer; font-size: 1rem; transition: background-color 0.2s;"
                onmouseover="this.style.backgroundColor='#1d4ed8'"
                onmouseout="this.style.backgroundColor='#2563eb'"
              >
                Login
              </button>
            </form>

            <div style="margin-top: 1.5rem; font-size: 0.875rem; color: #4b5563;">
              <p style="font-weight: 600; margin-bottom: 0.5rem;">Test Accounts:</p>
              <ul style="margin-left: 1.25rem; line-height: 1.75;">
                <li>owner@test.com / password123</li>
                <li>admin@test.com / password123</li>
                <li>viewer@test.com / password123</li>
              </ul>
            </div>
          </div>
        </div>
      `;

      document.getElementById('loginForm').addEventListener('submit', handleLogin);
    }

    // Render Dashboard
    function renderDashboard() {
      appContent.innerHTML = `
        <div style="min-height: 100vh; background-color: #f3f4f6; padding: 2rem;">
          <!-- Header -->
          <div style="background: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center;">
            <h1 style="font-size: 1.875rem; font-weight: bold; color: #111827;">Task Manager</h1>
            <div style="display: flex; align-items: center; gap: 1rem;">
              <span id="userDisplay" style="font-size: 0.875rem; color: #6b7280;"></span>
              <button id="logoutBtn" style="padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; background-color: #ef4444; color: white; border: none; cursor: pointer; transition: background-color 0.2s;"
                onmouseover="this.style.backgroundColor='#dc2626'"
                onmouseout="this.style.backgroundColor='#ef4444'"
              >
                Logout
              </button>
            </div>
          </div>

          <div style="max-width: 80rem; margin: 0 auto;">
            <!-- Create Task Form -->
            <div id="createTaskDiv" style="background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); padding: 1.5rem; margin-bottom: 2rem;">
              <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: #111827;">Create New Task</h2>
              <form id="createTaskForm" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <input
                  type="text"
                  id="taskTitle"
                  placeholder="Task title"
                  style="padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 1rem;"
                  required
                />
                <select
                  id="taskCategory"
                  style="padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 1rem;"
                >
                  <option value="Work">Work</option>
                  <option value="Personal">Personal</option>
                  <option value="Shopping">Shopping</option>
                  <option value="Health">Health</option>
                </select>
                <textarea
                  id="taskDesc"
                  placeholder="Description"
                  style="padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 1rem; grid-column: 1 / -1; resize: vertical; min-height: 3rem;"
                ></textarea>
                <button
                  type="submit"
                  style="grid-column: 1 / -1; padding: 0.75rem; border-radius: 0.375rem; font-weight: 600; background-color: #2563eb; color: white; border: none; cursor: pointer; font-size: 1rem; transition: background-color 0.2s;"
                  onmouseover="this.style.backgroundColor='#1d4ed8'"
                  onmouseout="this.style.backgroundColor='#2563eb'"
                >
                  Add Task
                </button>
              </form>
            </div>

            <!-- Tasks List -->
            <div style="background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); padding: 1.5rem;">
              <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: #111827;">Tasks</h2>
              <div id="tasksList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;"></div>
            </div>
          </div>
        </div>
      `;

      document.getElementById('logoutBtn').addEventListener('click', handleLogout);
      document.getElementById('createTaskForm').addEventListener('submit', handleCreateTask);
      document.getElementById('userDisplay').textContent = `${currentUser.email} (${currentUser.role})`;
      loadTasks();
    }

    // Handle Login
    async function handleLogin(e) {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      try {
        const res = await fetch(`${API_URL}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await res.json();
        if (res.ok) {
          authToken = data.access_token;
          currentUser = data.user;
          localStorage.setItem('access_token', authToken);
          localStorage.setItem('user', JSON.stringify(currentUser));
          renderDashboard();
        } else {
          alert('Login failed: ' + (data.message || 'Invalid credentials'));
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // Handle Logout
    function handleLogout() {
      localStorage.removeItem('access_token');
      localStorage.removeItem('user');
      authToken = null;
      currentUser = null;
      renderLogin();
    }

    // Handle Create Task
    async function handleCreateTask(e) {
      e.preventDefault();
      const title = document.getElementById('taskTitle').value;
      const description = document.getElementById('taskDesc').value;
      const category = document.getElementById('taskCategory').value;

      try {
        const res = await fetch(`${API_URL}/tasks`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({ title, description, category, status: 'TODO' })
        });

        if (res.ok) {
          document.getElementById('createTaskForm').reset();
          loadTasks();
        } else {
          alert('Failed to create task');
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // Load Tasks
    async function loadTasks() {
      try {
        const res = await fetch(`${API_URL}/tasks`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });

        const tasks = await res.json();
        const tasksList = document.getElementById('tasksList');
        tasksList.innerHTML = '';

        if (tasks.length === 0) {
          tasksList.innerHTML = '<p style="color: #6b7280;">No tasks found.</p>';
          return;
        }

        tasks.forEach(task => {
          const isViewer = currentUser.role === 'VIEWER';
          const statusColors = {
            'TODO': '#fbbf24',
            'IN_PROGRESS': '#60a5fa',
            'DONE': '#34d399'
          };

          const taskEl = document.createElement('div');
          taskEl.style.cssText = `
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1.5rem;
            background: white;
            display: flex;
            flex-direction: column;
            gap: 1rem;
          `;

          taskEl.innerHTML = `
            <div>
              <h3 style="font-weight: 600; font-size: 1.125rem; margin-bottom: 0.5rem; color: #111827;">${task.title}</h3>
              <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 0.75rem;">${task.description || 'No description'}</p>
              <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <span style="background-color: #e5e7eb; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; color: #374151;">${task.category}</span>
                <span style="background-color: ${statusColors[task.status]}; color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem;">${task.status}</span>
              </div>
            </div>
            <div style="display: flex; gap: 0.5rem;">
              <select 
                style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; ${isViewer ? 'opacity: 0.5; cursor: not-allowed;' : ''}"
                ${isViewer ? 'disabled' : ''}
                onchange="updateTaskStatus('${task.id}', this.value)"
              >
                <option value="TODO" ${task.status === 'TODO' ? 'selected' : ''}>To Do</option>
                <option value="IN_PROGRESS" ${task.status === 'IN_PROGRESS' ? 'selected' : ''}>In Progress</option>
                <option value="DONE" ${task.status === 'DONE' ? 'selected' : ''}>Done</option>
              </select>
              <button 
                onclick="deleteTask('${task.id}')"
                style="padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; background-color: ${isViewer ? '#d1d5db' : '#ef4444'}; color: white; border: none; cursor: ${isViewer ? 'not-allowed' : 'pointer'}; transition: background-color 0.2s; ${isViewer ? 'opacity: 0.5;' : ''}"
                ${isViewer ? 'disabled' : ''}
                onmouseover="${isViewer ? '' : "this.style.backgroundColor='#dc2626'"}"
                onmouseout="${isViewer ? '' : "this.style.backgroundColor='#ef4444'"}"
              >
                Delete
              </button>
            </div>
          `;
          tasksList.appendChild(taskEl);
        });
      } catch (err) {
        alert('Error loading tasks: ' + err.message);
      }
    }

    // Update Task Status
    async function updateTaskStatus(taskId, status) {
      try {
        const res = await fetch(`${API_URL}/tasks/${taskId}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({ status })
        });

        if (res.ok) {
          loadTasks();
        } else {
          alert('Failed to update task');
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // Delete Task
    async function deleteTask(taskId) {
      if (!confirm('Delete this task?')) return;

      try {
        const res = await fetch(`${API_URL}/tasks/${taskId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${authToken}` }
        });

        if (res.ok) {
          loadTasks();
        } else {
          alert('Failed to delete task');
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // Initialize
    const token = localStorage.getItem('access_token');
    const user = localStorage.getItem('user');
    if (token && user) {
      authToken = token;
      currentUser = JSON.parse(user);
      renderDashboard();
    } else {
      renderLogin();
    }
  </script>
</body>
</html>
  <app-root></app-root>
</body>
</html>
